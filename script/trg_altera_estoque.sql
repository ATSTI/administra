ALTER TRIGGER ALTERA_ESTOQUE ACTIVE
AFTER UPDATE
POSITION 0
as
DECLARE VARIABLE STOQ DOUBLE PRECISION;
DECLARE VARIABLE VLRATUAL DOUBLE PRECISION;
DECLARE VARIABLE PM DECIMAL(9,2);
DECLARE VARIABLE PMC DECIMAL(9,2);
DECLARE VARIABLE BASE DECIMAL(9,2);
begin
  /* 0 = ENTRADA */
  FOR SELECT ESTOQUEATUAL, PRECOMEDIO, VALORUNITARIOATUAL FROM PRODUTOS WHERE CODPRODUTO = NEW.CODPRODUTO
  INTO :STOQ, :PM, :VLRATUAL
  DO
  begin
    if (OLD.BAIXA = '0') then
      if (OLD.QUANTIDADE > STOQ) then
      begin
        BASE = ((OLD.QUANTIDADE - STOQ) + NEW.QUANTIDADE);
        IF (BASE > 0) THEN
          PMC = ((((OLD.PRECO * OLD.QUANTIDADE) - (STOQ * PM)) + (NEW.PRECO * NEW.QUANTIDADE))/BASE);
        update PRODUTOS set
          PRECOMEDIO = :PMC, 
          ESTOQUEATUAL = ((OLD.QUANTIDADE - :STOQ) + NEW.QUANTIDADE),
          VALORUNITARIOANTERIOR = VALORUNITARIOATUAL,
          VALORUNITARIOATUAL = (NEW.PRECO), 
          DATAULTIMACOMPRA = (SELECT DATAMOVIMENTO FROM MOVIMENTO WHERE CODMOVIMENTO = NEW.CODMOVIMENTO) 
        where CODPRODUTO = NEW.CODPRODUTO;
      end
      else
      begin
        BASE = ((STOQ - OLD.QUANTIDADE) + NEW.QUANTIDADE);
        IF (BASE > 0) THEN
          PMC = ((((STOQ * PM)-(OLD.PRECO * OLD.QUANTIDADE)) + (NEW.PRECO * NEW.QUANTIDADE))/BASE);
        update PRODUTOS set
          PRECOMEDIO = :PMC, 
          ESTOQUEATUAL = ((:STOQ - OLD.QUANTIDADE) + NEW.QUANTIDADE),
          VALORUNITARIOANTERIOR = :VLRATUAL,
          VALORUNITARIOATUAL = (NEW.PRECO), 
          DATAULTIMACOMPRA = (SELECT DATAMOVIMENTO FROM MOVIMENTO WHERE CODMOVIMENTO = NEW.CODMOVIMENTO) 
        where CODPRODUTO = NEW.CODPRODUTO;
      end

    /* 1 = SAÍDA */
    if (OLD.BAIXA = '1') then
    begin
      update PRODUTOS set
        ESTOQUEATUAL = ESTOQUEATUAL + OLD.QUANTIDADE,
        ESTOQUEATUAL = ESTOQUEATUAL - NEW.QUANTIDADE
      where CODPRODUTO = NEW.CODPRODUTO;
    end
  end 

end
